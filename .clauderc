# Contexto del Proyecto SQM - Sistema de Monitoreo Ambiental

## Descripci√≥n General

Sistema de monitoreo ambiental en tiempo real para hospitales y estaciones de medici√≥n de calidad del aire. Integra datos de m√∫ltiples fuentes IoT y APIs externas (MQTT, SERPRAM, AYT, ESINFA, SERCOAMB, Mimasoft) para proporcionar dashboards en tiempo real y reportes de calidad del aire.

## Stack Tecnol√≥gico

### Backend
- **Runtime:** Node.js (Express.js)
- **Base de Datos:** MySQL (con pools reader/writer separados)
- **Cache/Estado:** Redis (ioredis)
- **Autenticaci√≥n:** JWT (jsonwebtoken, bcryptjs)
- **Comunicaci√≥n IoT:** MQTT (mqtt.js)
- **Logging:** Winston
- **Timezone:** moment-timezone (America/Santiago)

### Frontend
- **Framework:** React
- **Gr√°ficos:** Componentes personalizados (StockAreaChart, WindRosePolarChart)
- **API Client:** Axios

### Infraestructura
- **Containerizaci√≥n:** Docker + Docker Compose
- **Proxy Reverso:** Nginx (en producci√≥n)
- **Arquitectura:** Monorepo (API y frontend en mismo servidor)

## Estructura del Proyecto

```
prueba-de-sqm/
‚îú‚îÄ‚îÄ server/                    # Backend Node.js
‚îÇ   ‚îú‚îÄ‚îÄ app.js                # Punto de entrada principal
‚îÇ   ‚îú‚îÄ‚îÄ config/               # Configuraciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.js       # Pools MySQL (reader/writer)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nombreEstaciones.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nombreVariables.js
‚îÇ   ‚îú‚îÄ‚îÄ controllers/          # Controladores HTTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ measurementController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serpramController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aytController.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ services/             # L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stateStore.js     # Gesti√≥n de estado con Redis
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ measurementService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serpramService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aytService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mqttService.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ repositories/         # Acceso a datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ measurementRepository.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mqttRepository.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ middleware/           # Middlewares Express
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authMiddleware.js # Autenticaci√≥n JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rateLimiters.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requestLogger.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Definici√≥n de rutas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apiRoutes.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ authRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ errorHandlers/        # Manejadores de errores
‚îÇ   ‚îú‚îÄ‚îÄ utils/                # Utilidades
‚îÇ   ‚îú‚îÄ‚îÄ store.js              # Wrapper de compatibilidad (Redis)
‚îÇ   ‚îî‚îÄ‚îÄ .env.example          # Template de variables de entorno
‚îÇ
‚îú‚îÄ‚îÄ client/                    # Frontend React
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îú‚îÄ‚îÄ page/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ HospitalDashboard.js
‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ           ‚îî‚îÄ‚îÄ api.js
‚îÇ
‚îú‚îÄ‚îÄ docker/                    # Configuraciones Docker
‚îÇ   ‚îî‚îÄ‚îÄ development/
‚îÇ       ‚îî‚îÄ‚îÄ mosquitto/
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ Documentaci√≥n/
    ‚îú‚îÄ‚îÄ AUTH_JWT_SETUP.md
    ‚îú‚îÄ‚îÄ REDIS_MIGRATION.md
    ‚îú‚îÄ‚îÄ CORS_SECURITY_CONFIG.md
    ‚îú‚îÄ‚îÄ INSTRUCCIONES_ROTACION_TOKEN_SERPRAM.md
    ‚îî‚îÄ‚îÄ INFORME_COMPLETO_AUDITORIA.md
```

## Arquitectura del Sistema

### Flujo de Datos

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Sensores   ‚îÇ
‚îÇ  IoT (MQTT) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend Node.js/Express            ‚îÇ
‚îÇ  ‚îú‚îÄ MQTT Service                    ‚îÇ
‚îÇ  ‚îú‚îÄ Schedulers (SERPRAM, AYT, etc.) ‚îÇ
‚îÇ  ‚îú‚îÄ Controllers ‚Üí Services ‚Üí Repos  ‚îÇ
‚îÇ  ‚îî‚îÄ StateStore (Redis)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚Üí MySQL (Writer/Reader Pools)
       ‚îú‚îÄ‚Üí Redis (Cache + Estado)
       ‚îî‚îÄ‚Üí APIs Externas (SERPRAM, AYT, etc.)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend   ‚îÇ
‚îÇ  React      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Fuentes de Datos

1. **MQTT**: Datos en tiempo real de sensores IoT
2. **SERPRAM**: API de monitoreo ambiental (Mejillones, Sierra Gorda, etc.)
3. **AYT**: Monitoreo de calidad del aire
4. **ESINFA**: Sistema de informaci√≥n ambiental
5. **SERCOAMB**: Servicios ambientales (Tamentica, Victoria)
6. **Mimasoft**: Integraci√≥n de aplicaciones

## Configuraci√≥n de Variables de Entorno

### Archivo `.env` (server/)

```env
# ===== APIs EXTERNAS =====
SERPRAM_API_URL=https://api.serpram.cl/air_ws/v1/api
SERPRAM_TOKEN=                 # JWT token de SERPRAM
SERPRAM_USER=
SERPRAM_PASS=

AYT_USER=
AYT_PASS=
AYT_TOKEN=

ESINFA_USER=
ESINFA_PASS=

SERCOAMB_USER_TAMENTICA=
SERCOAMB_PASS_TAMENTICA=
SERCOAMB_USER_VICTORIA=
SERCOAMB_PASS_VICTORIA=

# ===== BASE DE DATOS =====
DB_HOST=localhost
DB_NAME=datos_api
DB_PORT=3306
DB_WRITER_USER=
DB_WRITER_PASSWORD=
DB_READER_USER=
DB_READER_PASSWORD=

# ===== REDIS =====
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=                # Opcional

# ===== AUTENTICACI√ìN JWT =====
JWT_SECRET=                    # Generar con: node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
JWT_EXPIRES_IN=24h
API_USERNAME=admin
API_PASSWORD_HASH=             # Generar con bcrypt

# ===== FRONTEND Y CORS =====
ENABLE_CORS=false              # false en monorepo, true si frontend separado
FRONTEND_URL=http://localhost:3000

# ===== MQTT =====
MQTT_HOST=mqtt
MQTT_PORT=1883
MQTT_USERNAME=
MQTT_PASSWORD=

# ===== EMAIL =====
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASSWORD=
EMAIL_RECIPIENTS=

# ===== ENTORNO =====
NODE_ENV=development           # development o production
```

## Patrones y Convenciones

### Arquitectura en Capas

```
Routes (HTTP) ‚Üí Controllers ‚Üí Services ‚Üí Repositories ‚Üí Database/Redis
```

**Importante:**
- Controllers: Manejan HTTP, validaci√≥n de entrada, respuestas
- Services: L√≥gica de negocio, transformaciones
- Repositories: Acceso a datos (MySQL, Redis)

### Gesti√≥n de Estado

- **Antes (‚ùå):** `store.json` con `fs.writeFileSync()` (bloqueante)
- **Ahora (‚úÖ):** Redis con `stateStore.js` (as√≠ncrono, distribuido)

**Uso:**
```javascript
const stateStore = require('./services/stateStore');

// Guardar timestamp
await stateStore.setLastTimestamp('serpram', timestamp);

// Obtener timestamp
const ts = await stateStore.getLastTimestamp('serpram');
```

### Autenticaci√≥n JWT

**Endpoints p√∫blicos:**
- `POST /auth/login` - Obtener token
- `GET /auth/verify` - Verificar token
- `POST /auth/refresh` - Renovar token

**Proteger endpoints:**
```javascript
const { verifyToken, requireRole } = require('../middleware/authMiddleware');

router.get('/admin/config',
  verifyToken,           // Requiere token v√°lido
  requireRole('admin'),  // Requiere rol admin
  controller.getConfig
);
```

### CORS

**Configuraci√≥n flexible:**
- `ENABLE_CORS=false`: Modo monorepo (sin restricciones)
- `ENABLE_CORS=true`: Valida contra `FRONTEND_URL`

### Timezone

**Siempre usar America/Santiago:**
```javascript
const moment = require('moment-timezone');
const now = moment().tz('America/Santiago');
```

## Comandos Importantes

### Desarrollo

```bash
# Backend
cd server
npm install
npm run dev

# Frontend
cd client
npm install
npm start

# Redis (Docker)
docker run -d --name redis -p 6379:6379 redis:7-alpine

# MySQL (Docker Compose)
docker-compose up -d mysql
```

### Testing

```bash
# Autenticaci√≥n
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# Health Check
curl http://localhost:3001/api/health

# Redis
redis-cli
> KEYS state:*
> GET state:serpram:lastTimestamp
```

### Producci√≥n

```bash
# Build
npm run build

# Start
NODE_ENV=production npm start

# Logs
tail -f logs/combined.log
```

## Integraciones Externas

### SERPRAM
- **Frecuencia:** Cada 5 minutos
- **Dispositivos:** Mejillones, Sierra Gorda, SQM Baquedano, Maria Elena
- **Timestamp tracking:** Redis `state:serpram:lastTimestamp`
- **Timezone ajustado:** API -1 hora respecto a Chile

### AYT
- **Frecuencia:** Cada 1 minuto
- **Tags por estaci√≥n:** Configurados en `aytService.js`
- **Token management:** Auto-renovaci√≥n si 401
- **Sincronizaci√≥n nocturna:** Proceso batch para datos hist√≥ricos

### MQTT
- **Broker:** mosquitto (Docker)
- **Topics:** Por estaci√≥n y variable
- **Persistencia:** MySQL + Redis cache
- **Logger:** Winston dedicado

## Mejores Pr√°cticas

### Seguridad
- ‚úÖ **NUNCA** hardcodear credenciales
- ‚úÖ Usar variables de entorno
- ‚úÖ Tokens en `Authorization: Bearer <token>`
- ‚úÖ Passwords hasheados con bcrypt
- ‚úÖ CORS configurado seg√∫n entorno
- ‚úÖ Headers de seguridad habilitados
- ‚úÖ Rate limiting por endpoint

### Performance
- ‚úÖ Cache en Redis para lecturas frecuentes
- ‚úÖ Pools de conexi√≥n MySQL (reader/writer)
- ‚úÖ Operaciones as√≠ncronas (no bloquear event loop)
- ‚úÖ √çndices en queries frecuentes
- ‚úÖ Batch inserts cuando sea posible

### Logging
```javascript
const logger = require('./config/logger'); // Winston

logger.info('Mensaje informativo', { metadata });
logger.warn('Advertencia', { details });
logger.error('Error', { error: err.message, stack: err.stack });
```

### Error Handling
```javascript
async function handler(req, res, next) {
  try {
    // L√≥gica
  } catch (error) {
    next(error); // Pasar al error handler global
  }
}
```

## Problemas Comunes y Soluciones

### Redis no conecta
```bash
# Verificar que Redis est√° corriendo
redis-cli ping

# Iniciar Redis
docker start redis
```

### JWT_SECRET no configurado
```bash
# Generar secret
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# Agregar a .env
JWT_SECRET=valor_generado
```

### Token SERPRAM expirado
- Contactar administrador de SERPRAM
- Actualizar `SERPRAM_TOKEN` en `.env`
- Reiniciar servidor

### CORS bloqueando requests
- Verificar `ENABLE_CORS` en `.env`
- Para monorepo: `ENABLE_CORS=false`
- Para frontend separado: `ENABLE_CORS=true` + `FRONTEND_URL=https://...`

## Estado Actual del Proyecto

### ‚úÖ Completado (Fase 1 - Semana 1-2)

1. **Seguridad:**
   - Tokens migrados a variables de entorno
   - Autenticaci√≥n JWT implementada
   - CORS restrictivo configurado
   - Headers de seguridad (7 headers)
   - .gitignore mejorado

2. **Arquitectura:**
   - Store migrado a Redis
   - Escalabilidad horizontal desbloqueada
   - Thread-safe, sin race conditions
   - Fallback a memoria

3. **Documentaci√≥n:**
   - 5 gu√≠as t√©cnicas completas
   - Instrucciones de setup
   - Troubleshooting

### üìã Pendiente (Pr√≥ximas Fases)

1. **Resiliencia:**
   - Circuit Breakers en APIs externas
   - Schedulers distribuidos con Bull Queue
   - Health checks comprehensivos

2. **Observabilidad:**
   - Prometheus + Grafana
   - M√©tricas de aplicaci√≥n
   - Alertas configuradas

3. **Testing:**
   - Tests unitarios (objetivo 70%+)
   - Tests de integraci√≥n
   - Tests E2E

4. **Refactorizaci√≥n:**
   - app.js (separar schedulers)
   - AytService (dividir responsabilidades)
   - Migrar a async/await completo

## Referencias R√°pidas

### Endpoints Principales

**Autenticaci√≥n:**
- `POST /auth/login` - Login
- `GET /auth/verify` - Verificar token
- `POST /auth/refresh` - Renovar token

**Datos:**
- `GET /api/datos-PM10` - Datos PM10
- `GET /api/datos-PM25` - Datos PM2.5
- `GET /api/datos-SO2` - Datos SO2
- `GET /api/datos-viento` - Datos de viento
- `GET /api/datos-viento-hospital` - Viento Hospital (E5)
- `GET /api/promedios-hospital-24h` - Promedios 24h Hospital

**Reportes:**
- `GET /api/reportes/logs` - Generar reporte
- `GET /api/reportes/test-email` - Test de email

### Estaciones Principales

- **E5:** Hospital (estaci√≥n principal de dashboard)
- **Mejillones**
- **Sierra Gorda**
- **SQM Baquedano**
- **Maria Elena**

### Variables Ambientales Monitoreadas

- PM10, PM2.5 (Material particulado)
- SO2 (Di√≥xido de azufre)
- CO (Mon√≥xido de carbono)
- VV (Velocidad del viento)
- DV (Direcci√≥n del viento)
- Temperatura
- Humedad relativa
- Presi√≥n barom√©trica

## Contacto y Soporte

**Repositorio:** https://github.com/AngelRubilar/prueba-de-sqm
**Documentaci√≥n:** Ver archivos .md en ra√≠z del proyecto
**Issues:** Crear en GitHub

---

**√öltima actualizaci√≥n:** 2025-11-17
**Versi√≥n:** 1.0 (Post Fase 1 - Semana 1-2)

---

## Directivas para Revisi√≥n de C√≥digo (GitHub Actions)

### Prioridades en Code Review

Cuando Claude revise PRs en GitHub, debe enfocarse en:

1. **Seguridad Cr√≠tica:**
   - Nunca aprobar c√≥digo con credenciales hardcodeadas
   - Verificar que las variables de entorno se usen correctamente
   - Validar que no haya SQL injection, XSS, o command injection
   - Confirmar que los tokens/passwords usen bcrypt o similar
   - Verificar CORS y headers de seguridad

2. **Arquitectura en Capas:**
   - Controllers solo deben manejar HTTP (req, res, next)
   - Services contienen l√≥gica de negocio
   - Repositories acceden a DB/Redis
   - No mezclar responsabilidades entre capas

3. **Patrones Obligatorios:**
   - Usar async/await (NO callbacks)
   - Timezone siempre America/Santiago con moment-timezone
   - Redis para estado (NO archivos JSON)
   - Pools MySQL reader/writer correctamente
   - Error handling con try/catch y next(error)

4. **Performance:**
   - Operaciones as√≠ncronas no bloqueantes
   - Cache en Redis para datos frecuentes
   - Batch inserts cuando sea posible
   - √çndices en queries frecuentes

5. **Logging y Monitoreo:**
   - Winston logger en lugar de console.log
   - Niveles apropiados (info, warn, error)
   - Metadata √∫til en logs

### Checklist de Aprobaci√≥n

Antes de aprobar un PR, verificar:

- [ ] Sin credenciales hardcodeadas
- [ ] Arquitectura en capas respetada
- [ ] Error handling implementado
- [ ] Logging apropiado (Winston)
- [ ] Timezone correcto (America/Santiago)
- [ ] Sin operaciones bloqueantes
- [ ] Tests incluidos (cuando aplique)
- [ ] Documentaci√≥n actualizada si cambi√≥ API

### Rechazar Autom√°ticamente Si:

- Credenciales en c√≥digo
- SQL queries sin prepared statements
- Uso de eval() o Function()
- Dependencias con vulnerabilidades conocidas
- C√≥digo que bloquea el event loop
- Uso de fs.writeFileSync() para estado
